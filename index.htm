<!DOCTYPE html>
<html><head>
<meta http-equiv="content-type" content="text/html; charset=windows-1252"><title>Chemical composition calculations (as you type)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta name="description" content="Chemical Composition Calculator that calculates elemental analysis, monoisotopic mass, molecular ion pattern, and reaction equivalents all in your browser, meaning you can more quickly determine what your products are" />

<!-- base stylesheet -->
<style type="text/css" media="screen,print">

/* general settings */
body{font-family:arial;font-size:0.8em;padding:3px;margin:0;}
table{border-collapse:collapse;margin:3px 0px;border:1px solid #EFDE8B;}
td{padding:2px;}
table#periodic td{padding:0px;}
table#periodic a{padding:2px;}
thead td, .header div,.header{font-weight:bold;background-color:#9D8929;border:0px;color:#FFF9DB;}
table tr{}
h1,h3,h4{margin:5px 0px 2px;background-color:#243969;padding:3px;border-bottom:1px solid #BACEE0;color:#FFF;}

thead td{
	font-weight:bold;
	font-size:0.9em;
}
h1{margin-top:5px;font-size:1.5em;margin-bottom:0px}
input,select{background-color:#EEEEFF;border:1px solid black;margin: 3px 0px 0px 0px;color:black;border-radius: 2px;padding:2px;}
input #show_mass_spec{border:0px;}
input[reset]{margin-left:5px;}
select{background-color:#FFEEFF;margin-right:3px;height:22px;}
div{margin:0px;}

label{padding:2px;margin:0px 2px;}
label:hover{
	background-color:#FFF;
}

/* for those without JavasScript (likely to be a minority) */
noscript{
	color:red;
	border:2px solid red;
	background-color:white;
	font-weight:bold;
	padding:5px;
	border-radius:5px;
	margin:5px;
	font-size:2em;
	display:block;
}

.full_width{
	width:100%;
	clear:both;
}

/* loader icon
  - Dark blue spinner on transparent background
  - will be hidden initially
 */

.loading{background: none url(data:image/png;base64,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) no-repeat center center;height:40px;}

/* the outer wrapper */
#calculator{
	border-radius:5px;
	background-color:#C3CBDF;
	padding:2px 5px 5px;
	max-width:600px;
	margin-bottom:20px;
}

/* Composition */
.outline{border:1px solid #EFDE8B;border-radius:3px; overflow:hidden;background-color:#FFF;}
.header{margin-top:0;}
#share{float:right;padding-right:5px;}
#share input{width:100%;}

div.chn div{background-color:#DDDDFF;}
.align_r{text-align:right;}
.code{font-family:courier;color:black}
div.error{
	color:red;
	padding:5px;
	border:1px solid red;
	clear:both;border-radius:2px;
	background-color:#FFF;
}

input.error{
	border:1px solid red;color:red;
}
.warning{text-align:center;float:left;width:594px;clear:both;border:1px solid orange;padding:2px;background-color:#FFEECC;}
.formula{color:green;font-weight:bold;}
.highlighted{background-color:#EEEEFF;}
/* for long-winded calculations.  E.g. Sn6 */
#working{
	display:none;
	border:1px solid gray;
	background-color:#aaa;
}

/*
Help and shorthand links
*/
.help {position:absolute;right:0px;width:30%;text-align:left;background-color:#FFEBDB;padding:3px;border:1px solid #BBAA99;border-radius:4px;}
h2.toggles{display:inline-block;}
.toggles{text-align:right;}
.help_toggles{float:left;}
.shorthand h2,.help_toggles h2{margin:0px 2px;border-bottom:0px;font-size:14px;display:inline-block;background-color:none;}
.help h2{margin:0px;}
.shorthand{

	overflow:auto;
	background-color:#EEEEEE;border-bottom:1px solid #BACEE0;
}
.shorthand a{text-decoration:none;}
.information{width:220px;text-align:right;float:left;}
.data{width:375px;float:left;padding-left:3px}
.chn{}

/* units */
  /* unit heading */
.u_h{font-style:italic;}
.mass{width: 70px;float:left;text-align:center;}
input.mass{width:60px;text-align:right;}
.unit{margin-left:5px;width: 60px;float:left;text-align:center;}
.volume{float:left;width:60px;text-align:center;}
#volume{width:60px;text-align:right;}
.density{float:left;width:60px;text-align:center;}
input.density{margin-left:10px;width:45px;text-align:right;}

.update{float:left;width:70px;text-align:center;}
.mmols{width:90px;float:left;text-align:center;}
input.mmols{width:80px;text-align:right;margin-left:10px;}
.equivalents{width:35px;float:left;text-align:center;}
input.equivalents{width:35px;text-align:right;margin-left:0px;}
select.unit{width:50px;}
/* .auto_overflow{width:600px} */


/*

Shorthand and isotope output

*/

#shorthand{
	visibility:hidden;
	display:none;
	/*background-color:#BBDDBB;*/
	clear:both;
}
#shorthand table{background-color:#FFF;}
#element_list,#shorthand{
	visibility:hidden;
	display:none;
	background-color:#FFF9DB;
	border:1px solid #6476A0;
	border-radius: 2px;
	padding:2px;
	overflow:auto;
	clear:both;
	position: absolute;
	right:2px;
}

#element_list table{
	margin:0px;
}

.blank{opacity:0;}
#element_info{
	right:440px;position:absolute;top:8px;
	visibility:hidden;
	display:none;
	width:150px;
	border:1px solid #6476a0;
	background-color:#fff9db;
	border-radius:2px;
}
#element_info b{display:none;}
#element_info h6{
	margin:6px 0px 3px;padding:0px;
	font-size:12px;
}
div.c_e{float:left;width:20%;text-align:center;margin-top:0px;}
td.c_e{width:18px;height:15px;background-color:#fff;}
.c_e a{display:block;;}
.c_e a:hover{background-color:#CCCCDD;}
.no_isotopes_entered{background-color:#ffebdb;display:none;}

/* elemental composition output */
.element{    float:left;width:20%;}
.num_atoms{  float:left;width:20%;}
.atomic_mass{float:left;width:20%;}
.net_mass{   float:left;width:20%;}
.percent_composition{float:left;width:20%;}
.ms_header{float:left;width:100%;}
.m_z{padding:0px;float:left;width:10%;font-style:italic;}
.ms_intensity{float:left;width:78%;}
.ms_intensity div.percentage{height:10px;margin-bottom:4px;}
.ms_intensity_num{float:left;width:12%; text-align:right;}
.info{width:100%;clear:both;}
#conversion_section{width:550px;float:left;}
.cossh_form{margin-bottom:0.5em;}

/* hide until needed */
#composition{display:none;}

/* quick elemental analysis */
#element_analysis{
	background-color:#FFFFDF;
	clear:both;
}
.e_c, .e_h, .e_n, .multiplier, #yields{width:50px;margin-right:5px;float:left;text-align:center;color:#888888;}
#e_c, #e_h, #e_n{color:black;}
.e_c input, .e_h input, .e_n input, .multiplier input{margin:0px;width:45px;color:#AAAAAA;}
.e_c input.field_enter_text, .e_h input.field_enter_text, .e_n input.field_enter_text, .multiplier input.field_enter_text{color:black;margin-right:5px;}
#chn_copy_paste{clear:both;padding-top:3px;padding-left:3px;}
/* 'footer' */
.bottom,.iupac{
	margin-top: 10px; color: rgb(136, 136, 136); font-size: 0.9em;text-align:right
}
.iupac a{color: rgb(136, 136, 136);}
.bottom{
		position: fixed;bottom: 10px;
}

#bottom_left{left:10px;}
#bottom_right{right:10px;}

/* generic */
.clearfix {display:inline-block;}

/* Hides from IE-mac \*/
* html .clearfix {height: 1%;}
.clearfix {display: block;clear:both;}
/* End hide from IE-mac */

</style>

<!-- printable stylesheet -->
<style type="text/css" media="print">
.help, .shorthand{display:none;}
</style>

<!-- small screens -->
<style type="text/css" media="screen and (max-width: 640px)">
/* some things only show on a larger screen */
.large-screen{display:none;}

.error{width:97.5%;}

#calculator{margin-top:33px;}
.shorthand,.help{width:97%;}

/* on small screens, having the help auto-load is not useful*/
#help{display:none;}
.help{right:auto;}


/* in this case it looks better at the bottom-right */
#bottom_right{padding-bottom:1.5em;}
#bottom_left{right:10px;}

/* elemental information on a small screen.
Remember we don't have a :hover state accessible, and we have a smaller screen

format changes from tall box to wide rectangle to place in space of the periodic table
*/
#element_info{top:15px;right:auto;left:45px;width:190px;}
#element_info b,#element_info h6,#element_info div{font-weight:normal;display:inline;}
#element_info div.iso{display:inline-block;width:48%;}

</style>

<style type="text/css" media="screen and (max-width: 400px)">
.cossh_form{clear:both;}
</style>

<!-- 
Google analytics.  

This is used for visitor numbers, and possibly
determining what is actually most used so that things can be improved.

I might use it to log events which take a long time.  If I do (currently do not), only
the event and formula will be logged, as that will be all I need to replicate/fix the issue.
-->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-23464216-2');
  ga('send', 'pageview');
</script>


<!-- the CCalc object that is to do all work, once refactored -->
<script type="text/javascript">

var CCalc = {
	calculating:false,
	/* place to store the shorthand and periocid table; don't regenerate the HTML unnecessarily */
	shorthand:'',
	periodic:'',

	/* store values already iterated over, so don't have to re-predict values of formula if same */
	cache_initial:{
		formula:'',
		formula_expanded:'',
		formula_condensed:'',
		c:'',
		h:'',
		n:'',
		m_z:''
	},
	cache:[],

	timing:[],

	// this works assuming you've been on signa aldrich
	msds:'https://www.sigmaaldrich.com/catalog/search?interface=All&N=0&mode=match%20partialmax&focus=product&term=',

	// function so we don't access objects directly
	is_calculating:function(){
		return this.calculating;
	},

	set_calculating:function(){
		this.calculating = true;
	},

	finished_calculating:function(){
		this.calculating = false;
	},


	cache_check:function(f){
		return (typeof(CCalc.cache[f]) != 'undefined')?true:false;
	},

	cache_key_check:function(f,key){
		return (CCalc.cache_check(f) && (CCalc.cache[f][key]) != '')?true:false;
	},

	/* this initialises the cache only*/
	cache_add:function(f){
		// can't just copy this as it will copy a reference.  Need to manually
		// copy all values from the initial reference (sigh)
		var temp = {},i = '';
		for (i in CCalc.cache_initial){
			temp[i] = CCalc.cache_initial[i];
		}

		// set it all up now
		CCalc.cache[f] = temp;
	},

	// f => formula (simplified)
	cache_set:function(f,key,value){
		if(!CCalc.cache_check(f)){
			CCalc.cache_add(f);
		}

		CCalc.cache[f][key] = value;

	},
	
	// get an item from the cache
	// f => formula (simplified)
	cache_get:function(f,key){
		if(!CCalc.cache_check(f)){
			return '';
		}

		return CCalc.cache[f][key];

	},

	/* browser console logging? */
	logging:true,
	logging_enabled:false,
	
	/* iteration information */
	expand_it:0,

	/* only when proven around so we allow it. 
	May be started offline ... */
	google_analytics:'',

	/* iniversal message generator */
	message:function(message, type){
		return '<div class="'+type+'">'+message+'</div>';
	},

	log:function(msg){
		if(this.logging){
			this.check_logging();
			if(this.logging_enabled == true){
				window.console.log(msg);
			}
		}
	},

	/* is a console.log enabled? */
	check_logging:function(){
		this.logging_enabled = (window.console && window.console.log)?true:false;
	},

	/* if we have google analytics, then fire off the function.  It we don't, then we're fairly stuffed */
	ga_exists:function(){
		if(typeof(CCalc.google_analytics) == 'boolean'){
			return CCalc.google_analytics;
		}

		// if we're here, then we don't have it checked for
		CCalc.check_ga_exists
	},

	/* quick check for it being available */
	check_ga_exists:function(){
		CCalc.google_analytics = (typeof(window.ga) == 'function')? true:false;
	},

	/* reset functions */
	reset_all:function(){
		CCalc.html.setVal('c','');
		CCalc.html.setVal('h','');
		CCalc.html.setVal('n','');
		CCalc.html.setVal('multiplier','');

		set_class('c','');set_class('h','');set_class('n','');set_class('mult','');
		CCalc.html.set('e_c','');CCalc.html.set('e_h','');CCalc.html.set('e_n','');
		CCalc.html.set('c_found',0);CCalc.html.set('h_found',0);CCalc.html.set('n_found',0)
		CCalc.html.set('c_expected','');CCalc.html.set('h_expected','');CCalc.html.set('n_expected','');
		CCalc.html.set('molecular_formula','');
		if(CCalc.html.get_el('formula').value == ''){
			hide(('chn_copy_paste'));
		}
		hide(('composition'));
		hide(('working'));
	},

	/* is this element we have something that's acutally viable? */
	is_viable:function(item){
		return this.is_element(item) || this.is_shorthand(item);
	},

	/* simple check that this is a shorthand?*/
	is_shorthand:function(item){
		return (CCalc.fragments[item])?true:false;
	},

	/* is this an element? */
	is_element:function(item){
		return (CCalc.elemental[item])?true:false;
	},

	/*
	takes a string, expands it fully out to show how many of a certain element are therein
	does not do the expanding of shorthand, but this is done separately
	*/
	expand:function(formula){
		this.expand_it++;
		// this.log(expand_formula_iteration+") Given the formula '"+formula+"'");

		var curr_elem_num = 0;
		var tmp_formula,i,len,tmp_match,pattern;
	
		var formula_mod = this.expand_brackets(formula);

		// match the elements.
		var elements_match = formula_mod.match(/((\.?[0-9*])?[\(\[]*[A-Z][a-z]*[0-9\.]*)/g);

	
		// check we've matched something entered
		if(
			(formula_mod.length && formula_mod.length>0)
			&& (isArray(elements_match) && elements_match.length>0)
		){
			len = elements_match.length;

			//might need to multiply items if inside brackets
			for(i=0;i<len;i++){
				// got a match of [a-z][0-9].  will need to split those apart, and form a
				// NEW array containing element and amount.  Note, we need to check if an element has already
				// been added so that formulas such as NiNO3.6H20 work well
				if(elements_match[i]){

					tmp_match = elements_match[i].match(/([A-Z][a-z]*)([0-9\.]*)/);
					// for the elements already added, we can use to check if already in 'elem_added'/not
					pattern= new RegExp(tmp_match[1]+',');
					// force it to definitely be a string, and with no whitespace at the ends
					tmp_match[1] = new String(tmp_match[1].replace(/^\s+|\s+$/g, ''));
					// check if we've not yet added this to the 'elem_added variable' (in the loop after an 'onkeyup')
					// if not, set the chem_element value to 0, else each time a keypress is registered we add to what's already there
					if(!pattern.test(elem_added) && CCalc.elemental[tmp_match[1]]){
						CCalc.elemental[tmp_match[1]][3] = 0;
					}
					// add a value of 1 where 1 is assumed e.g. the oxygen in H2O
					if((tmp_match[1].length>0) && (tmp_match[2].length == 0)){
						tmp_match[2]=1;
//								tmp_string += "<br>setting to '1' the number of "+tmp_match[1];
					}
					// Make sure that the matched value is a number
					else{tmp_match[2] = parseFloat(tmp_match[2]);}

					// fragments should have been simplified out of here a long time ago
					if(!CCalc.elemental[tmp_match[1]] && !CCalc.fragments[tmp_match[1]]){
						tmp_string += CCalc.message('Unknown element/shorthand <b>'+tmp_match[1]+'</'+'b>','error');
					}
					else{
//					tmp_string+= "Added "+tmp_match[1]+"<sub>"+tmp_match[2]+"</"+"sub> ("+formula_mod+")<br>";
						tmp_string = add_element(pattern,tmp_string,tmp_match[1],tmp_match[2],curr_elem_num);
					}
				}
			}
		}
	},
	
	/* we don't worry about bracket types */
	expand_brackets:function(formula){
		var tmp_match;var key;
		var pattern_elements = '/([A-Z][a-z]*)([0-9\.]*)/g';
		var reg_brackets = '/\(([^\[\(]*)\)([0-9\.]*)/';

		var tmp_formula;var tmp_elements;var tmp_elements_all;
		var brackets_error = "You appear to have a <em>mismatched</em> or <em>empty set</em> of brackets <br>e.g. <span class=code>C6H3<b class=highlighted>(</"+"b>CH2Cl</"+"span> or <span class=code>C6<b class=highlighted>()</"+"b></"+"span>";
		// misc variables
		var i=0;var a;var tmp;
		// ignore any empty brackets
		//  tmp_string+= "<br>expand_brackets(): working with "+formula;

		// we don't care which type we use internally
		formula = formula.replace(/[\[\{]/,'(');
		formula = formula.replace(/[\]\}]/,')');

		formula = formula.replace(/\(\)/,'');



		var i_max = 10;

		/* currently loops 'i_max times, if square brackets used */
		while(formula.match(/[\[\(]/)){
			tmp_match = [];tmp_formula = '';
			try{
				// clear the error message on each loop
				CCalc.html.set('error','');
				CCalc.html.get_el('error').className = '';

				/* match curved brackets */
				if(formula.match(/\(([a-z0-9]*)\)([0-9\.]*)/i)){
					// temporarily get the information out
					tmp_match = formula.match(/\(([a-z0-9]*)\)([0-9\.]*)/i);
					// this.log(tmp_match);
				}
				/* something's gone really wrong here, and we'll stop */
				else{
					CCalc.html.set('error',brackets_error);
					CCalc.html.get_el('error').className = 'error';
					break;
				}
			}
			catch(e){tmp_string += "<br>Error message of: "+e;}

			// matched something
			if(tmp_match.length>0){
				// check for a value of '' after a bracket
				if(tmp_match[2].length==0){tmp_match[2] = 1;}
				
				/* reset some values*/
				tmp_formula = '';tmp_elements = '';tmp_elements_all = '';

				// match all style of formulae in the brackets
				tmp_elements_all = String(tmp_match[1]).match(/([A-Z][a-z]*[0-9\.]*)/g);
				
				// and now we go through again
				for(a=0;a<tmp_elements_all.length;a++){
					// now match individual elements
					tmp_elements = String(tmp_elements_all[a]).match(/([A-Z][a-z]*)([0-9\.]*)/);
					// check we've not got a n element with an implicit value of '1'
					if(tmp_elements[1].length>0){
						if(!tmp_elements[2]){tmp_elements[2] = 1;}
						tmp_elements[2] = tmp_match[2]*tmp_elements[2];
						tmp_formula += tmp_elements[1]+tmp_elements[2];
					}
				}

				// replace in the formula the section we matched and dealt with
	//			 tmp_string += "<br>"+i+") Temporary formula becomes: '"+tmp_formula+"' while trying to replace '"+tmp_match[0]+"' with '"+tmp_formula+"'";
				// replace all types of brackets
				formula = formula.replace(/\(([a-z0-9]*)\)([0-9\.]*)/i,tmp_formula);
			}
			else{
	//			 tmp_string+= "could not match anything in "+formula+" tmp_match has no values in it at all";
			}
			// check if we go too far (far, far too many brackets)
			i++;
			if(i>i_max){
				break;
			}
		}

		return(formula);
	},

	simplify:function(formula){
		// formula needs expanding
		formula = this.expand_brackets(formula);

		// variables we're about to use
		var matches,i;

		// to store the elements found
		var condensed = [];

		var regex = /([A-Z][a-z]*)([0-9]*)/g;
		while(matches = regex.exec(formula)){
			// elements with an implicit number of 1
			if(matches[2] == ''){matches[2] = 1;}

			// not found already?
			if(!condensed[matches[1]]){
				condensed[matches[1]] = 0;
			}

			// add in the current number of matches
			condensed[matches[1]] += parseInt(matches[2]);
		}



		// stupid as this looks, we're going to rebuild the formula with expanded shorthand
		var tmp = '';
		var redo = false;
		for (i in condensed){
			if(CCalc.is_shorthand(i)){
				tmp +='('+CCalc.fragments[i]+')'+condensed[i];
				redo=true;
			}
			else{
				tmp += i+condensed[i];
			}
		}

		// get a consistent method of the condensed formula
		var ret = '';

		// no shorthand present
		if(redo == false){
			condensed.sort();	
			// loop the data to add in
			for(i in condensed){
				// implicit '1' being snuffed
				if(condensed[i] == 1){
					condensed[i] = '';
				}
				ret += i+condensed[i];
			}
		}
		else{
			ret = this.simplify(tmp);
		}

		return ret;
	},

	checkShared: function(){
		var el = CCalc.html.get_el('formula');
		// get the window.location.hash and see if we need take information from this
		// note a browser might prefill this on a restore, or on a reload
		if(el.value=='' && window.location.hash.length>0){
			// perhaps a bit too trusting?
			el.value = this.getHash();
		}
	},

	// we want the value without the '#'
	getHash:function(){
		return window.location.hash.replace(/#/,'');
	},

	// we want the value without the '#'
	setHash:function(h){
		// this.log('setting the hash to '+h);
		window.location.hash = h
	},

	clearHash:function(){
		// this.log('clearing the hash');
		window.location.hash = '';
	},

	// add in sharing functionality
	share:function(){
		var share = CCalc.html.get_el('share');
		// clean slate
		share.innerHTML = '';

		var form = CCalc.html.make_el('form');
		var input = CCalc.html.make_el('input');

		input.value = window.location.href;

		// so we can share things
		input.addEventListener('blur',CCalc.share_reset,false);



		// overwrite so we can add in fields
		form = share.appendChild(form);
		input = form.appendChild(input);

		input.focus();
		input.select();

	},

	/* remove the share form and put it back to where it was */
	share_reset:function(){
		CCalc.html.get_el('share').innerHTML = 'share';
	},

	mass_spec:function(elemental_composition, formula_simplified){
		var r = '';
		// clear the global variable of information
		mass_spec_info = [];

		// so we can normalise things
		mass_spec_max_percentage = 0.0000001;
		var percentage = 0;
		var bg;var prev_m_z = 0;var shown=false;
		var i;var tmp = [];var j = 0;



		if(!CCalc.cache_key_check(formula_simplified,'m_z')){
			CCalc.start_timing('m_z');


			// start as 1 as we're doing a multiplication
			var isotope_combinations = 1;
			var count = 0;
			for (i in elemental_composition){
				count = 0;
				for (j in elemental_composition[i][2]){
					count++;
				}

				isotope_combinations  = isotope_combinations * count;
			}

		  // log the number of isotopes that are being calculated
		  // if(window.ga){
		  // 	ga('send','mass spec', 'isotopes', isotope_combinations);
		  // }


			// e.g. Sn6
			// this takes typically >2 seconds...
			if(isotope_combinations >1000000){
				if(confirm('Calculating the Mass spec could take a while.  Do you want this to happen?')==false){
					return 'Mass spec calculation has been cancelled';
				}
			}


			// work it out (uses a global value)
			run_through_isotopes(elemental_composition,0,0,[],[0,1]);

			// sort the information
			// due to JavaScript's poor support for numbered incides, we're going to have:
			// to loop through the data,
			// making the indices a value,
			// sort based on the value, and THEN display the information (joy)
			
			for(i in mass_spec_info){
				
				tmp[j] = [i,mass_spec_info[i]];

				if(mass_spec_max_percentage<mass_spec_info[i]){
					mass_spec_max_percentage = mass_spec_info[i];
				}
				j++;
			}
			tmp.sort();

			CCalc.cache_set(formula_simplified,'m_z',tmp);
			CCalc.cache_set(formula_simplified,'m_z_max_percent',mass_spec_max_percentage);
			CCalc.end_timing('m_z');

		  // GOOGLE analytics event for the mass spec
		  ga('send','timing','mass spec', String(isotope_combinations), CCalc.get_timing('m_z'));

		}
		else{
			// console.log(formula_simplified+ ' loaded from cache');
			tmp = CCalc.cache_get(formula_simplified,'m_z');
			mass_spec_max_percentage = CCalc.cache_get(formula_simplified,'m_z_max_percent');
		}	

		var k=0;
		// output it
		r+="<div>";j=0;
		// for later comparison
		var tmp_len = r.length;
		// modern browsers


		for(var i in tmp){
			// percentage of total
			percentage = parseFloat(tmp[i][1])/parseFloat(mass_spec_max_percentage)*100;
			// format nicely
			percentage = percentage.toFixed(4);
			// check if needed to show due to being too small
			if(!shown && (percentage<mass_spec_min_visible)){continue;}
			else{shown=true;}
	//					 console.info("Ion '"+tmp[i][0]+"' -- prev_m_z = '"+prev_m_z+"'");
			if(j%2 == 1){bg = 'highlighted';}else{bg='';}
			if((prev_m_z>0) && (tmp[i][0]-prev_m_z)>1){
	//			console.info("attempting iterations: ");
				for(k=1;k<(tmp[i][0]-prev_m_z);k++){
	//				console.info("iteration "+k);
					r+= CCalc.html.m_z_row(prev_m_z+k,'','',bg);
					// backgrounds
					j++;if(j%2 == 1){bg = 'highlighted';}else{bg='';}
				}
			}

			r+= CCalc.html.m_z_row(tmp[i][0],percentage,percentage,bg);

			j++;
			prev_m_z = parseInt(tmp[i][0]);
		}
	  // check for no information
		if(r.length == tmp_len){r+="<div class=\"warning\">One (or more) of the elements you've entered does not have isotopic abundance data entered into this system.<br><i>The mass spectrum cannot be calculated</"+"i><br><br>This could be because no data exists, or because the sustance is naturally radioactive and so does not have a stable isotopic composition</"+"div>";}
	  r +='</'+'div>';

		return(r);
	},

	start_timing:function(key){
		CCalc.timing[key] = {start:new Date().getTime(),end:0,diff:0};
	},

	end_timing:function(key){
		CCalc.timing[key].end = new Date().getTime();

		// work out the difference in milliseconds as that's what we care about
		CCalc.timing[key].diff = this.timing[key].end-this.timing[key].start;
	},

	get_timing: function(key){
		return CCalc.timing[key].diff;
	}

}


/*
extend the CCalc object and use it to allow HTML transformations
This extension makes things testable :)

*/
CCalc.html = {
	img_src: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAAKCAYAAAB10jRKAAAAAXNSR0IArs4c6QAAAAZiS0dEAP8A/wD/oL2nkwAAAAlwSFlzAAALEwAACxMBAJqcGAAAABRJREFUCNdjYGBo+M/EwMDAQCwBAEdGAZK3aijLAAAAAElFTkSuQmCC',

	/*

	details for tables

	*/
	td:function(msg,cls){
		cls = (cls.length && cls.length>0)?' class="'+cls+'"':'';
		return '<td'+cls+'>'+msg+'</td>';
	},
	tr:function(arr){
		var html=  '';
		var i;
		// build the row?
		if(arr.length>0){
			html += '<tr>';
			for (i in arr){html += this.td(arr[i],'');}
			html += '</tr>';
		}
		return html;
	},

	/* a few blank columns?  */
	spacing_columns:function(from,to,current){
		html = '';

		for(i=from;i<to;i++){
			html += this.td('','blank');
		}

		return {current:i,html:html}
	},

	// set the innerHTML of an element.  Code written using this becomes shorter
	set:function(id,str){
		var el = this.get_el(id);
		if(el !== false){
			el.innerHTML = str;
		}
		return el;
	},
	append:function(id,str){
		var el = this.get_el(id);
		if(el !== false){
			el.innerHTML += str;
		}
		return el;
	},

	// handles all checks neatly
	get_el:function(id){
		if(document.getElementById){
			return document.getElementById(id);
		}
		else{return false;}
	},

	// wrapper for document.createElement
	make_el:function(tag){
		if(typeof(tag)=='string'){
			return document.createElement(tag);
		}
		return false;
	},

	/*

	Forms

	*/
	// get a form element value
	getVal:function(id){
		var el = this.get_el(id);
		if(el !== false){
			return el.value;
		}
		else{return '';}
	},

	setVal:function(id, val){
		var el = this.get_el(id);
		if(el !== false){
			el.value = val;
		}
	},

	errorText:function(id){
		var el = CCalc.html.get_el(id);
		if(el === false || typeof(el) =='undefined'){return;}
		if(el.className.match(/ ?error ?/)){return;}
		set_class(el,'error');
	},

	removeClass:function (id,to_remove){
		var el = CCalc.html.get_el(id);
		if(!el || el === false || typeof(el) =='undefined'){return;}
		var reg = new RegExp(' ?'+to_remove+' ?');
		var cn = el.className.replace(reg,'');
		el.className = cn;
		;
	},

	/* adds in the subscripts as needed */
	make_pretty: function(f){
		return f.replace(/(\d+)/g,"<sub>$1</sub>");
	},

	m_z_row: function(m_z,percentage,percentage,bg){
		var r = '';
		r+='<div class="'+bg+'">';
		r+= '<div class="m_z '+bg+'">'+m_z+'&nbsp;</'+'div>';
		r+='<div class="ms_intensity '+bg+'">';
		// display a percentage
		if(percentage>0){
			r += '<div style="width:'+percentage+'%" class="percentage"><img src="'+this.img_src+'" style="width:100%;height:10px" alt="'+percentage+'%"></'+'div>';
		}else{r+='&nbsp;';}
		r+= '</'+'div>';
		r+='<div class="ms_intensity_num '+bg+'">'+percentage+'% </'+'div>';
		r+='<div class="clearfix"></'+'div></'+'div>';


		return r;
	}

 }
</script>

<!-- element information -->
<script type="text/javascript">
/* elemental information */
CCalc.elemental = {
	// ordering based on periodic table so can update/add easily.
	// not alphabetical, though would be possible
	// takes information on row and column information so that can easily build periodic table from information

	// all values for masses taken from Sigma-Aldrich wall chart, and precise mass used where known
	// format of array is Array(ROW,COL,PRECISE_MASS,NUM_ELEMENTS_IN_FORMULA,MOST_COMMON_ISOTOPE,array(OTHER_ISOTOPES=>percentages_as_numbers_not_decimals);
	// MOST_COMMON_ISOTOPE is used for creating the monoisotopic mass

	// row1
	H:   [1, 1,  1.0079,    0,1,  {1:99.9885,2:0.0115},1,1],
	He:  [1, 18, 4.002602,  0,4,  {3:0.000137,4:99.999863},1,18],
	// row 2
	Li:  [2, 1, 6.941,      0,7,  {6:7.59,7:92.41},2,1],
	Be:  [2, 2, 9.012182,   0,9,  {9:100},2,2],

	// row 2, p block
	B:   [2, 13, 10.811,    0,11, {10:19.9,11:80.1}],
	C:   [2, 14, 12.0107,   0,12, {12:98.93,13:1.07}],
	N:   [2, 15, 14.0067,   0,14, {14:99.632,15:0.368}],
	O:   [2, 16, 15.9994,   0,16, {16:99.757,17:0.038,18:0.205}],
	F:   [2, 17, 18.998403, 0,19, {19:100}],
	Ne:  [2, 18, 20.1797,   0,20, {20:90.48,21:0.27,22:9.25}],

	// row 3
	Na:  [3, 1, 22.98977,   0,23, {23:100}],
	Mg:  [3, 2, 24.305,     0,24, {24:78.99,25:10,26:11.01}],

	// row 3, p block
	Al:  [3, 13, 26.981538, 0,27, {27:100}],
	Si:  [3, 14, 28.0855,   0,28, {28:92.2297,29:4.6832,30:3.0872}],
	P:   [3, 15, 30.973761, 0,31, {31:100}],
	S:   [3, 16, 32.065,    0,32, {32:94.93,33:0.76,34:4.29,36:0.02}],
	Cl:  [3, 17, 35.453,    0,35, {35:75.78,37:24.22}],
	Ar:  [3, 18, 39.948,    0,40, {36:0.3365,38:0.0632,40:99.6003}],

	// row 4
	K:  [4, 1, 39.0983,     0,39, {39:93.25811,40:0.011672,41:6.73022}],
	Ca: [4, 2, 40.078,      0,40, {40:96.941,42:0.647,43:0.135,44:2.086,46:0.004,48:0.187}],
		// row 4, d-block metals
	Sc: [4, 3 , 44.95591,   0,45, {45:100}],
	Ti: [4, 4 , 47.867,     0,48, {46:8.249,47:7.437,48:73.720,49:5.409,50:5.185}],
	V:  [4, 5 , 50.9415,    0,51, {50:0.2497,51:99.7503}],
	Cr: [4, 6 , 51.9961,    0,52, {50:4.3452,52:83.7895,53:9.5006,54:2.3647}],
	Mn: [4, 7 , 54.938049,  0,55, {55:100}],
	Fe: [4, 8 , 55.845,     0,56, {54:5.845,56:91.754,57:2.1191, 58:0.2819}],
	Co: [4, 9 , 58.9332,    0,59, {59:100}],
	Ni: [4, 10, 58.6934,    0,58, {58:68.0769,60:26.2231,61:1.1399,62:3.6345,64:0.9256}],
	Cu: [4, 11, 63.546,     0,63, {63:69.174,65:30.826}],
	Zn: [4, 12, 65.409,     0,64, {64:48.63,66:27.90,67:4.10,68:18.75,70:0.62}],
	// row 4, p-block
	Ga: [4, 13, 69.732,     0,69, {69:60.1079,71:39.8921}],
	Ge: [4, 14, 72.64,      0,74, {70:21.234,72:27.662,73:7.717,74:35.943,76:7.444}],
	As: [4, 15, 74.9216,    0,75, {75:100}],
	Se: [4, 16, 78.96,      0,80, {74:0.889,76:9.366,77:7.635,78:23.772,80:49.607,82:8.731}],
	Br: [4, 17, 79.904,     0,79, {79:50.686,81:49.314}],
	Kr: [4, 18, 83.798,     0,84, {78:0.35351,80:2.28086,82:11.58304,83:11.49533,84:56.9889,86:17.29835}],

	//row 5
	Rb: [5, 1, 85.4678,     0,85, {85:72.1654,87:27.8346}],
	Sr: [5, 2, 87.62,       0,88, {84:0.5574,86:9.8566,87:7.0015,88:82.5845}],
	// row 5, d-block metals
	Y:  [5, 3 , 88.90585,   0,89, {89:100}],
	Zr: [5, 4 , 91.224,     0,90, {90:51.452,91:11.223,92:17.146,94:17.380,96:2.799}],
	Nb: [5, 5 , 92.90638,   0,93, {93:100}],
	Mo: [5, 6 , 95.94,      0,98, {92:14.8362,94:9.2466,95:15.9201,96:16.6756,97:9.5551,98:24.1329,100:9.6335}],
	Tc: [5, 7 , 98,         0,98, {98:100}],
	Ru: [5, 8 , 101.07,     0,102,{96:5.542,98:1.8688,99:12.7579,100:12.5985,101:17.0600,102:31.5519,104:18.6210}],
	Rh: [5, 9 , 102.9055,   0,103, {103:100}],
	Pd: [5, 10, 106.42,     0,106, {102:1.020,104:11.14,105:22.33,106:27.33,108:26.46,110:11.72}],
	Ag: [5, 11, 107.8682,   0,107, {107:51.8392,109:48.1608}],
	Cd: [5, 12, 112.411,    0,114, {106:1.25,108:0.89,110:12.49,111:12.80,112:24.13,113:12.22,114:28.73,116:7.49}],
		// row 5, p-block
	In: [5, 13, 114.818,    0,115, {113:4.288,115:95.712}],
	Sn: [5, 14, 118.71,     0,120, {112:0.973,114:0.659,115:0.339,116:14.536,117:7.676,118:24.223,119:8.585,120:32.593,122:4.629,124:5.789}],
	Sb: [5, 15, 121.76,     0,121, {121:57.213,123:42.787}],
	Te: [5, 16, 127.6,      0,130, {120:0.096,122:2.603,123:0.908,124:4.816,125:7.139,126:18.952,128:31.687,130:33.799}],
	I:  [5, 17, 126.90447,  0,127, {127:100}],
	Xe: [5, 18, 131.293,    0,132, {124:0.08913,126:0.08880,128:1.91732,129:26.43964,130:4.08721,131:21.17961,132:26.89157,134:10.44232,136:8.8680}],

	// row 6
	Cs: [6, 1, 132.9045,    0,133, {133:100}],
	Ba: [6, 2, 137.327,     0,138, {130:0.1058,132:0.1012,134:2.417,135:6.592,136:7.853,137:11.232,138:71.699}],
		// row 6, d-block metals
	La: [6, 3 , 138.9055,   0,139, {138:0.09017,139:99.90983}],
	Hf: [6, 4 , 178.49,     0,178, {174:0.1620,176:5.2604,177:18.5953,178:27.2811,179:13.6210,180:35.0802}],
	Ta: [6, 5 , 180.9479,   0,181, {180:0.0123,181:99.9877}],
	W:  [6, 6 , 183.84,     0,184, {180:0.1198,182:26.4985,183:14.3136,184:30.6422,186:28.4259}],
	Re: [6, 7 , 186.207,    0,187, {185:37.398,187:62.602}],
	Os: [6, 8 , 190.23,     0,192, {184:0.0197,186:1.5859,187:1.9644,188:13.2434,189:16.1466,190:26.2584,92:40.7815}],
	Ir: [6, 9 , 192.217,    0,193, {191:37.272,193:62.728}],
	Pt: [6, 10, 195.078,    0,195, {190:0.013634,192:0.782659,194:32.96700,195:33.831557,196:25.24166,198:7.16349}],
	Au: [6, 11, 195.96655,  0,197, {197:100}],
	Hg: [6, 12, 200.59,     0,202, {196:0.15344,198:9.968,199:16.873,200:23.096,201:13.181,202:29.863,204:6.865}],
		// row 6, p-block
	Tl: [6, 13, 204.3833,   0,205, {203:29.524,205:70.476}],
	Pb: [6, 14, 207.2,      0,208, {204:1.4245,206:24.1447,207:22.0827,208:52.3481}],
	Bi: [6, 15, 208.98038,  0,209, {209:100}],
	Po: [6, 16, 209,        0,209, {}],
	At: [6, 17, 210,        0,210, {}],
	Rn: [6, 18, 222,        0,222, {}],

	// row 7
	Fr: [7, 1, 223,         0,223, {}],
	Ra: [7, 2, 226,         0,226, {}],
		// row 7, d-block metals
	Ac: [7, 3, 227,         0,227, {}],

	Rf: [7, 4, 261,         0,261, {}],
	Db: [7, 5, 262,         0,262, {}],
	Sg: [7, 6, 266,         0,266, {}],
	Bh: [7, 7, 264,         0,264, {}],
	Hs: [7, 8, 277,         0,277, {}],
	Mt: [7, 9, 268,         0,268, {}],
	Ds: [7, 10, 281,        0,281, {}],
		// row 7, p-block (very little data, so most not shown)
	Uuu: [7, 11, 272,       0,272, {}],
	Uub: [7, 12, 285,       0,285, {}],
	// Uut: [1, 1, ,0,,{}],
	Uuq: [7, 1, 289,        0,289, {}],

	// Lactinides and actinides as a new set ofrows, as per 'normal'
	// row 6, Lanthanides/f-block
	// dummy spacer
	dummy:[8,1],

	Ce: [9, 1 ,140.116,     0,140, {136:0.186,138:0.251,140:88.449,142:11.114}],
	Pr: [9, 2 , 140.90765,  0,141, {141:100}],
	Nd: [9, 3 , 144.24,     0,142, {142:27.16,143:12.18,144:23.83,145:8.30,146:17.17,148:5.74,150:5.62}],
	Pm: [9, 4 , 145,        0,145, {}],
	Sm: [9, 5 , 150.36,     0,152, {144:3.0734,147:14.9934,148:11.2406,149:13.8189,150:7.3796,152:26.7421,154:22.7520}],
	Eu: [9, 6 , 151.964,    0,153, {151:47.810,153:52.190}],
	Gd: [9, 7 , 157.25,     0,158, {152:0.2029,154:2.1809,155:14.7998,156:20.4664,157:15.6518,158:24.8347,160:21.8635}],
	Tb: [9, 8 , 158.92534,  0,159, {159:100}],
	Dy: [9, 9 , 162.5,      0,164, {156:0.056,158:0.096,160:2.34,161:18.91,162:25.51,163:24.90,164:28.19}],
	Ho: [9, 10, 164.93032,  0,165, {165:100}],
	Er: [9, 11, 167.259,    0,166, {162:0.137,164:1.609,166:33.61,167:22.93,168:26.79,170:14.93}],
	Tm: [9, 12, 168.93421,  0,169, {169:100}],
	Yb: [9, 13, 173.04,     0,172, {168:0.127,170:3.04,171:14.28,172:21.83,173:16.13,174:31.83,176:12.76}],
	Lu: [9, 14, 174.967,    0,175, {175:97.416,176:2.584}],

		// row 7, actinides
	Th: [10, 1 ,232.0381,   0,232, {}],
	Pa: [10, 2 , 231.03588, 0,231, {}],
	U:  [10, 3 , 238.02891, 0,238, {}],
	Np: [10, 4 , 237,       0,237, {}],
	Pu: [10, 5 , 244,       0,244, {}],
	Am: [10, 6 , 243,       0,243, {}],
	Cm: [10, 7 , 247,       0,247, {}],
	Bk: [10, 8 , 247,       0,247, {}],
	Cf: [10, 9 , 251,       0,251, {}],
	Es: [10, 10, 252,       0,252, {}],
	Fm: [10, 11, 257,       0,257, {}],
	Md: [10, 12, 258,       0,258, {}],
	No: [10, 13, 259,       0,259, {}],
	Lr: [10, 14, 262,       0,262, {}],

	// Uup: [1, 1, ,0,,{}],
	// Uuh: [1, 1, ,0,,{}],
	// Uus: [1, 1, ,0,,{}],
	// Uuo: [1, 1, ,0,,{}],


	// so we can have a ',' at the end of all lines and not forget things
	end_el:[]
}

</script>

<!-- common fragment information -->
<script type="text/javascript">
<!--

/*
The fragments which get expanded, but are also used to build the table.
*/
CCalc.fragments = {
	Me:   'CH3',
	Et:   'CH2CH3',
	Pro:  '(CH2)2CH3',
	Bu:   '(CH2)3CH3',
	Vi:   'HCCH2',
	Ph:   'C6H5',
	Ac:   'COCH3',
	Cy:   '(CH2)5CH',
	Cp:   '(CH)5',
	Dmf:  '(CH3)2NCOH',
	Def:  '(CH3)2(CH2)2NCOH',
	Thf:  'C4H8O',
	Dmso: '(CH3)2SO',
	Dcm:  'CH2Cl2'
}

// -->
</script>



<!-- original code, slowly being refactored -->
<script type="text/javascript">
<!--

/*
These global elements will be removed to make the working clearer and object scope clearer.

DO NOT RELY on these
*/
var elements_used = '';
var chem_isotopes;
var mass=0;
var molecular_mass = 0;
var max_decimal_places = 20;
var elem_added = '';
var tmp_string = '';
var formula_simplified = '';
var formula_formatted;
var curr_elem_num = 0;
var expand_formula_iteration = 0;
var mass_used = 0;
var mmol_used = 0;
var prev_formula = '';
var mass_spec_info = [];
var mass_spec_max_percentage = 0.000000001;
// minimum percentage to need for showing in the mass spec peaks
var mass_spec_min_visible =0.01;
var show_mass_spec;
// all values for masses taken from Sigma-Aldrich wall chart, and precise mass used where known
// format of array is Array(PRECISE_MASS,NUM_ELEMENTS_IN_FORMULA,MOST_COMMON_ISOTOPE,array(OTHER_ISOTOPES=>percentages_as_numbers_not_decimals);
// MOST_COMMON_ISOTOPE is used for creating the monoisotopic mass


// -->
</script>



<!-- the heavy lifting -->
<script type="text/javascript">
<!--
// scientific reasoning on the significant figures after the decimal place is thus:  you can't have
// anything more precise than that which is the least precise.  i.e. 0.5+0.00005 = 0.5 because the first
// measurement was not measured so accurately, and is actually 0.5 with a variance of 0.049 which nullifies
// the 0.00005 measurement

function calculate_info(formula){
	// declare (clear) the variables
	var info = '';
	var i=0;
	tmp_string = '';
	max_decimal_places = 6;
	var key=0;
	elem_added = '';formula_simplified = '';var formula_mod = '';
	mass=0;
	var mono_mass = 0;
	CCalc.expand_it = 0;

	// check that the checked field is even valid before performing checks
	if(show_mass_spec == null){
		show_mass_spec = CCalc.html.get_el('show_mass_spec').checked? 1:0;
	}

	// we will need to check for a change in the state of the checkbox for the mass spec too
	// do we have to run through?   Keys back and forth don't count
	if((formula == prev_formula) && (show_mass_spec == (CCalc.html.get_el('show_mass_spec').checked? 1:0))){
		return false;
	}
	else{prev_formula = formula;}

	CCalc.set_calculating();

	// as we've changed the forumula, we'll update the hash in the url so that we can share the url with others
	CCalc.setHash(formula);

  // reset first as we don't always have a clean slate
  CCalc.reset_all();
  if(formula.replace(/ */,'')==''){
		return;
	}

	show(('working'));

	// update the show mass spec field if we gt this far
	show_mass_spec = CCalc.html.get_el('show_mass_spec').checked? 1:0;

	// use the DOM method
	if(document.getElementById){
		// to replace the other function
		formula_simplified = CCalc.simplify(formula);
		CCalc.expand(formula_simplified);

		// need to do the caching?
		if(CCalc.cache_check(formula_simplified) == false){
			CCalc.cache_add(formula_simplified);
		}

	
		// output
		// make the formula look pretty
		// formula_formatted = formula.replace(/([^\(\[\{])([a-zA-Z]*)([0-9\.]*)/g,"$1$2<sub>$3</"+"sub>");
		formula_formatted = CCalc.html.make_pretty(formula);
		// add to the string

		if(elem_added.length>0){

			// set up a var to store the table while we work out the base formula
			var tmp_string2='';formula_simplified = '';
			// remove the end ','
			elem_added = elem_added.replace(/,$/,'');
			var elem_split = elem_added.split(',');
			var tmp_mass=0;
			var bg_num=0;var bg;var num_atoms;var atom_mass;
			var show_ms = (CCalc.html.get_el('show_mass_spec').checked == true)?true:false;

			// show the header
			show(('composition'));
			
			// array to pass to the mass spec function arrays of(element name, number_of elements)
			var ms = [];var len = elem_split.length;var j=0;
			var num_isotopes = 1;var tmp_num = 0;var chn = 0;var classes = '';var bg;
			for(i=0;i<len;i++){
				classes = '';
				// got to exist
				if(elem_split[i].length>0 && (CCalc.elemental[elem_split[i]][3]>0)){

					// CHN get highlighted
					classes += ((elem_split[i] == 'C')||(elem_split[i] == 'H')||(elem_split[i] == 'N'))?'chn ':'';
					// colour
					bg_num++;if((bg_num % 2)>0){classes += ' highlighted';}
					// number of atoms
					num_atoms = CCalc.elemental[elem_split[i]][3];
					if(Math.ceil(num_atoms) !=num_atoms && isNumeric(parseFloat(num_atoms))){num_atoms =parseFloat(num_atoms).toFixed(3);}
					// an atom's mass
					atom_mass = CCalc.elemental[elem_split[i]][2];
					tmp_mass = parseFloat(CCalc.elemental[elem_split[i]][2]*num_atoms).toFixed(max_decimal_places);
					mono_mass += num_atoms*CCalc.elemental[elem_split[i]][4];
					// html/not for class names
					classes = (classes.length>0)?' class="'+classes+'"':'';
					tmp_string2+='<div'+classes+'><div class="element">'+elem_split[i]+'</'+'div><div class="num_atoms">'+num_atoms+'</'+'div><div class="atomic_mass">'+atom_mass+'</'+'div><div class="net_mass align_r">'+tmp_mass+'</'+'div><div class="percent_composition align_r">'+parseFloat(tmp_mass/mass*100).toFixed(max_decimal_places)+'%</'+'div><div class=clearfix></'+'div></'+'div>';
					// update elemental analysis fields
					if(elem_split[i] == 'C' ||elem_split[i] == 'H' ||elem_split[i] == 'N') {
						CCalc.html.set(elem_split[i].toLowerCase()+'_expected',parseFloat(tmp_mass/mass*100).toFixed(2));
					}
					// the simplified formula
					formula_simplified += elem_split[i];
					// check for non-integer value
					if(Math.ceil(CCalc.elemental[elem_split[i]][3]) ==CCalc.elemental[elem_split[i]][3]){formula_simplified +=CCalc.elemental[elem_split[i]][3];}
					else{formula_simplified += CCalc.elemental[elem_split[i]][3].toFixed(2);}

					// mass spec information; number of isotopes too
					for(var x=0;x<num_atoms;x++){
						ms[j] = [elem_split[i],1,CCalc.elemental[elem_split[i]][5]];
						j++;
					}
				}

			}
//			 tmp_string +="total number of isotopes: '"+num_isotopes+"'<br>";
			// buil the mass spec out of the data
			ms = (show_ms)? CCalc.mass_spec(ms,formula_simplified) :'';
			tmp_string2 += '</'+'div></'+'div>';
			
			// still need to make sure that we don't have errant '1' as needed
			var formula_no_html = CCalc.simplify(formula_simplified);

			// format the simplified formula
			formula_simplified = CCalc.html.make_pretty(CCalc.simplify(formula_simplified));

			// remove 'C<sub>1</'+'sub>'
			// formula_simplified = formula_simplified.replace(/<sub\>1\<\/sub>/g,'');

			var msds_link = CCalc.msds+formula_no_html;

			// set the correct amounts in the correct place
			CCalc.html.set('condensed_formula',formula_simplified);
			CCalc.html.set('condensed_composition',elem_added.replace(/,/g,", "));
			CCalc.html.set('condensed_mass',mass.toFixed(max_decimal_places));
			CCalc.html.set('condensed_mono',mono_mass.toFixed(max_decimal_places));
			CCalc.html.set('condensed_msds', "<a href=\""+msds_link+"\" target=\"_blank\">search</"+"a>");
			// update teh elemental analysis copy paste
			CCalc.html.set('molecular_formula',formula_simplified);

			var mmols = (document.chemicals.amt_added.value*1000/mass);
			molecular_mass = mass.toFixed(max_decimal_places);
		}


		// update the div
		// get a reference to the DIV we're going to populate
		show(('composition'));
		info = CCalc.html.set('info',tmp_string2);
		info.style.className = 'info';

		// if we have a mass spec to show, then do so
		if(show_ms){
			show(('mass_spec'));
			CCalc.html.set('mass_spec_graph', ms);
		}
		else{hide(('mass_spec'));}
		
		// tidy up the UI
		hide(('working'));
		CCalc.finished_calculating();

		// google analytics
		var ms_ga = (show_ms)?1:0;
		ga('send','event','calculation','finished',String(ms_ga));

	}

}

function add_element(pattern,tmp_string,elem_curr,elem_amt,curr_elem_num){
	var tmp = '';
	if(elem_amt == 0){return('');}
	// make sure we've not already encountered the symbol
	if(CCalc.elemental[elem_curr][3] >0){
		// if so, increase the current element count by the amount already entered
			curr_elem_num += (parseFloat(CCalc.elemental[elem_curr][3])+elem_amt);
//			tmp_string += "<br>found "+elem_curr+" before ("+CCalc.elemental[elem_curr][1]+")";
		}
		else{
			curr_elem_num = elem_amt;
//			tmp_string += "<br><i>never</"+"i> found "+elem_curr+" before ("+CCalc.elemental[elem_curr][1]+")..";
		}
		// increase the total mass by the number we addd in this amount
		mass += CCalc.elemental[elem_curr][2]*elem_amt;

		// get the number of decimal places used in the measuremnt.	if less than the initial (or subsequent) value(s), then make the figure shorter
		tmp = String(CCalc.elemental[elem_curr][2]).split('.');
		if(tmp[1]){
			if(String(tmp[1]).length<max_decimal_places){max_decimal_places = String(tmp[1]).length}
		}


//	tmp_string+= "<br>trying to add "+elem_curr+" ("+curr_elem_num+" atoms)";
	// add the information
		try{
			// number
			CCalc.elemental[elem_curr][3] = curr_elem_num;
			// add to list of added elements so we don't trawl through all 118 off them in the end
			if(!elem_added.match(pattern)){
//				tmp_string+= "<br>added "+elem_curr+" ==&gt; number of atoms: "+CCalc.elemental[elem_curr][1]+" ("+curr_elem_num+"); &nbsp; mass of that number of atoms: "+CCalc.elemental[elem_curr][3]+"::";
				elem_added +=elem_curr+',';
			}
			else{
//				tmp_string += "already found "+elem_curr+" in "+elem_added;
			}

		}
		catch(e){
			tmp_string += 'Error message for "'+elem_curr+'" while adding to array: "'+e+'"';
		}
//		if(!(smg['a'+elem_curr])){tmp_string += 'adding '+elem_curr+'failed<br>';}
//		else{tmp_string+= '=&gt;Added '+elem_curr+', CCalc.elemental[a'+elem_curr+'] = '+multiplier+'*'+elem_amt+'.  We now have '+smg.length+' chemical elements added<br>';}
	;
	return tmp_string;
}

function expand_brackets(formula){
}





// show the shorthand supported
function shorthand(visible){
	var id;
	if(CCalc.html.get_el('shorthand')){
		if(CCalc.shorthand ===''){
			var shorthand = 'Shorthand:<br>';
			// gather the information
			var i,f;
			shorthand +='<table>';
			// generate all rows
			for(i in CCalc.fragments){
				// it's nicer pretty
				f = CCalc.html.make_pretty(CCalc.fragments[i]);
				// HTML building
				shorthand += CCalc.html.tr([i,'=&gt;',f]);
			}

			shorthand += '</table>';
			CCalc.shorthand = shorthand;
		}
		else{
			shorthand = CCalc.shorthand;
		}
		// populate it with the information
		id = CCalc.html.set('shorthand',shorthand);
		// set its height to '0', make it visible, and then try to make it visibl
//			alert(id.style['visibility']);
		show_hide('shorthand');
	}
	return false;

}
// show the shorthand supported
function element_list(visible){
	var id;
  var element_list_2 = '';

	var data;
	if(CCalc.html.get_el('element_list')){
		if(CCalc.periodic !==''){
			element_list_2 = CCalc.periodic;
		}
		else{
			var element_list_2 = '<table id="periodic">';
			var element_list = 'Elements:<br>';
			// gather the information
			var i, no_isotopes, j;
			var row, col;
			row=col=1;

			// loop through the data
			for(i in CCalc.elemental){
	//				console.log(i+"\t"+row+'::'+col+' vs. '+CCalc.elemental[i][0]+'::'+CCalc.elemental[i][1]);
				if(i=='end_el'){break;}

				data = '';
				no_isotopes = 'class="no_isotopes_entered"';
				// check for at least 1 isotope.	if not, we display it as a red flag
				for(j in CCalc.elemental[i][5]){
					if(j>0){
						no_isotopes = '';
						break;
					}
				}

				// rows
				if(parseInt(CCalc.elemental[i][0]) != row){
					if(row!=1){element_list_2 += '</'+'tr>';}
					element_list_2 +='<tr>';
					row++;
					col=0;
				}

				// spacer for lanthanid and actinides
				if(i=='dummy'){
					element_list_2 +='<tr><td colspan=18>&nbsp;</td></tr>';
					row++;
					continue;
				}

				// spacing columns
				if(CCalc.elemental[i][1]-col>1){
					// fixes an odd bug I've not time to fix, yet
					if(row>1){col++;}
					tmp = CCalc.html.spacing_columns(col,CCalc.elemental[i][1],col);
					element_list_2 += tmp.html;
					col = tmp;
				}
				else{col++;}

				// data
				data = 'class="c_e"><a href="#" onmouseover="show_element_info(\''+i+'\')" onmouseout="show_element_info(\''+i+'\')" onclick="show_element_info(\''+i+'\');return false;" title="Mass: \''+CCalc.elemental[i][4]+'\',  Monoisotopic mass:\''+CCalc.elemental[i][2]+'\'" '+no_isotopes+'">'+i+'</'+'a></';
				element_list_2 +='<td '+data+'td>';
				element_list+='<div '+data+'div>'+"\n";
			}
			element_list_2 += '</'+'tr></'+'table>';

			// add in source of data
			element_list_2 += '<div class="iupac"><a href="http://www.iupac.org/reports/1998/7001rosman/iso.pdf" style="text-decoration:none;" target="_blank">Isotope data from Iupac report</'+'a></'+'div>';

			// cache this
			CCalc.periodic = element_list_2;
		}


		// populate it with the information
		id = CCalc.html.set('element_list',element_list_2);
		// set its height to '0', make it visible, and then try to make it visibl
//			alert(id.style['visibility']);
		show_hide('element_list');
	}
	return false;

}

function show_element_info(id){
	var element_data,element_isotopes = '';
	hide(('no_isotopes_entered'));

	if(CCalc.html.get_el('element_info')){
		if(CCalc.elemental[id]){
			element_data = "<i>"+id+" </"+"i><div><span class='large-screen'>Mass:</span><b>(</b>"+CCalc.elemental[id][2]+"<b>)</b></div>";
			var i;
			if(typeof(CCalc.elemental[id][5]) == 'object'){
				element_data+="<div><b> - </b><span class='large-screen'>Monoisotopic mass:</span> "+CCalc.elemental[id][4]+" </div>"

				// show out all the isotopes (or not)
				var summing = 0;
				for(i in CCalc.elemental[id][5]){
					element_isotopes+="<div class='iso'>"+i+" <span class='large-screen'>- </span><b>: </b>"+CCalc.elemental[id][5][i]+"%<b>, </b></"+"div>";
					summing = summing + CCalc.elemental[id][5][i];
				}
				if(element_isotopes.length==0){
					show(('no_isotopes_entered'));
				}
			}
			CCalc.html.set('element_data',element_data);
			CCalc.html.set('element_isotopes',element_isotopes);
			show_hide('element_info');

		}
	}
}

/* pass an object */
function show(o){
	if(!o.style && typeof(o)=='string'){
		o = CCalc.html.get_el(o);
	}
	
	o.style.visibility = 'visible';
	o.style.display = 'block';
}

/* pass an object */
function hide(o){
	if(!o.style && typeof(o)=='string'){
		o = CCalc.html.get_el(o);
	}
	o.style.visibility = "hidden";
	o.style.display = 'none';
}

function show_hide(element){
	if(CCalc.html.get_el(element)){
		var o = CCalc.html.get_el(element);
//			alert(element+'--> style.visibility = '+o.style.visibility+"\n"+'style.display = '+o.style.display);
		if(o.style.visibility =='hidden'){
			show(o);
		}
		else{
			hide(o);
		}
	}
}

function update_mmols(mol_mass){;
	if(isNaN(CCalc.html.getVal('mass'))){
		CCalc.html.errorText('mass');
		return;
	}
	CCalc.html.removeClass('mass','error');
	CCalc.html.setVal('mmols', CCalc.html.getVal('mass')*CCalc.html.getVal('mass_multiplier')/mol_mass/CCalc.html.getVal('mmol_multiplier'));
	// reset the equivalents
	CCalc.html.setVal('equivalents',1);
}
function update_mass(mol_mass){
	if(isNaN(CCalc.html.getVal('mmols'))){
		CCalc.html.errorText('mmols');
		return;
	}
	CCalc.html.removeClass('mmols','error');
	// update the mass
	CCalc.html.setVal('mass', CCalc.html.getVal('mmols')*CCalc.html.getVal('mmol_multiplier')*CCalc.html.getVal('equivalents')*mol_mass/CCalc.html.getVal('mass_multiplier'));
	// update the volume
	update_volume(mol_mass);

}

function update_mmols_volume(mol_mass){;
	CCalc.html.setVal('mmols', CCalc.html.getVal('volume')/CCalc.html.getVal('volume_multiplier')*CCalc.html.getVal('density')/mol_mass/CCalc.html.getVal('mmol_multiplier'));
	// reset the equivalents
	CCalc.html.setVal('equivalents', 1);
}

function update_volume(mol_mass){
	// update the volume based on the density
		CCalc.html.setVal('volume', CCalc.html.getVal('mmols')*CCalc.html.getVal('mmol_multiplier')*mol_mass/CCalc.html.getVal('density')*CCalc.html.getVal('volume_multiplier'));
}


// will need to call itself iteratively to make this all work
// run_through_isotopes(array_all_info,number,value_from_object,array_of_final_ions,??)
function run_through_isotopes(info,curr_elem,curr_isotope,all_ions,ion_info){
	var curr_mass;var tmp;
	/* mass spec max percentage can only increase.	
	If it's likely to bea peak that will likely be noise, we need to kill it off
	as this will slow down calculations
	*/
	if(((ion_info[1]/mass_spec_max_percentage)<(mass_spec_min_visible/10))){
		// return false;
		// console.info("Stopped ion of "+ion_info[1]+"% from being added.  Molecular mass was:"+ion_info[0]+" max_mass_spec: "+mass_spec_max_percentage);
	}
	
	if(info[curr_elem] && (typeof(info[curr_elem][2]) == 'object')){
		// tmp vars
		var tmp;
		// loop through the isotopes, and call recursively if needed
		for(var i in info[curr_elem][2]){
			curr_isotope=i;
			curr_mass = parseFloat(ion_info[0])+parseFloat(i);
//			console.info(curr_isotope+"	 : "+i+" : "+info[curr_elem][2][i]+" -- Gives: mass number of '"+curr_mass+"' and probability of '"+(parseFloat(ion_info[1])*(info[curr_elem][2][i]/100))+"'");

			tmp = run_through_isotopes(
				info,
				curr_elem+1,
				i,
				all_ions,
				[curr_mass,parseFloat(ion_info[1])*(info[curr_elem][2][i]/100)]
			);
		}
	}
	else{
//		console.info("STOP! got the following ion: '"+ion_info[0]+"' with an 'abundance' listed at: '"+ion_info[1]+"'");
		// set a new max percentage, if needed
		if(ion_info[1]>mass_spec_max_percentage){mass_spec_max_percentage = ion_info[1];}
		// add percentage value if needed
		if(mass_spec_info[ion_info[0]]){
//				 console.info("appending information");
			ion_info[1] += mass_spec_info[ion_info[0]];
		}
		// for debug only
//			 else{				console.info("setting first instance of ion");}
		if(ion_info[1]){
			mass_spec_info[ion_info[0]] = ion_info[1];
		}
	}
	return(true);
}

function toggleInputText(field_obj,initial_text,initial_class,highlighted_class){
	if(!field_obj.value){return;}
	// reset the text
	if(field_obj.value.replace(/\s/g,'')==''){
		field_obj.value=initial_text;
		// note this will clear any classes set
		set_class(field_obj,initial_class);
	}
	// clear the text
	else if(field_obj.value == initial_text){
		field_obj.value = '';
		set_class(field_obj,highlighted_class);
	}
}

// set the classes for objects
function set_class(objectID,new_class){
	if (document.getElementById) {
		// perhaps already an object passed?
		if(objectID && typeof(objectID) == 'object' && objectID.style){
			objectID.className += ' '+new_class;
		}
		else if(CCalc.html.get_el(objectID)){
			CCalc.html.get_el(objectID).className += ' '+new_class;
		}
	}
	else if (document.layers){
		if(document.layers[object]) {document.layers[objectID][className] = new_class;}
		// perhaps already an object passed?
		else if(objectID[style]){objectID[className] = new_class;}
	}
	else if (document.all) {
		if(document.all[objectID]){document.all[objectID].className = new_class;}
		else if(objectID.style){objectID.className = new_class;}
	}
}

function calculate_chn(){
	var c, h, n, multiplier;

	// can we?
	if(document.getElementById){
		if(CCalc.html.getVal('formula').length >0
			&& CCalc.html.get_el('chn_copy_paste').style.visibility == 'hidden'){
				show_hide('chn_copy_paste');
		}

		// get the values
		c = CCalc.html.getVal('c');
		h = CCalc.html.getVal('h');
		n = CCalc.html.getVal('n');
		multiplier = CCalc.html.getVal('multiplier');

		// default values
		if(!isNumeric(c)){c = 0;}if(!isNumeric(h)){h = 0;}if(!isNumeric(n)){n = 0;}if(!isNumeric(multiplier)){multiplier = 1;}

		// write into section for copy paste to documents
		CCalc.html.set('c_found',c);
		CCalc.html.set('h_found',h);
		CCalc.html.set('n_found',n);
		// check we're not doing something stupid with div/0
		if(c+h+n == 0){return false;}
		// alert('calculating CHN');

		// convert to initial mol
		c = c/12.011;
		h = h/1.0079;
		n = n/14.007;
		// sort to figure out which is the smaller
		var tmp = [c,h,n];
		tmp.sort(function(a,b){return a - b});
		min = 0;
		for(var a in tmp){
			if(tmp[a] == 0){continue;}
			else{min = tmp[a];}
		}
		// normalise everything & round off.  note, need *100, then /100 to round to 2 decimals
		c=Math.round(c/min*multiplier*100)/100;
		h=Math.round(h/min*multiplier*100)/100;
		n=Math.round(n/min*multiplier*100)/100;

		// write the values
		CCalc.html.set('e_c',c);
		CCalc.html.set('e_h',h);
		CCalc.html.set('e_n',n);
	}
}


/*

Functions that should remain so (not as part of an object)

*/

// check for an array of an object
function isArray(obj) {
	if(obj){
		if (obj.constructor.toString().indexOf("Array") == -1){return false;}
		else{return true;}
	}else{return false;}
}


function isNumeric(value) {return typeof value != "boolean" && value !== null && !isNaN(+ value);}


/*
 onload event to set up all the handlers

*/
window.onload=function(){
  // so we can start typing
  CCalc.html.get_el('formula').focus();

  // do we have an shared url?
  CCalc.checkShared();

  calculate_info(document.chemicals.formula.value);calculate_chn();
	/* add event listeners */
	CCalc.html.get_el('reset_form').addEventListener('click',reset_button_click);

	// so we can share things
	CCalc.html.get_el('share').addEventListener('click',CCalc.share,false);
}


/* */
window.onhashchange = function(){
	// check if calculating
	if(!CCalc.is_calculating()){
		h = CCalc.getHash();
		if(h.length>0){
			var f = CCalc.html.get_el('formula');
			// update the field
			f.value = h;

			calculate_info(f.value);calculate_chn();
		}
	}
	else{}
}


function reset_button_click(){
	 molecular_mass='';var a123 = CCalc.html.get_el('error');a123.innerHTML = '';a123.className='';calculate_info('');
	 CCalc.clearHash();CCalc.reset_all();
}
//-->
</script>

<meta name="description" content="Predict elemental analysis & mass spectra, speed up COSSH forms, reverse predict formulae from elemental analysis.  All in real time" />
</head>

<!-- template for the HTML -->
<body>

<!-- warnings for unsupported technology -->
<noscript>
Hello.  You appear to have Javascript disabled.  Unfortunately for you, this tool requires javascript tuned on.  Please enable it, and refresh the page
</noscript>

<!-- we don't support IE less than v8 as we are using inline images which don't work -->
<!--[if IE lt 8]>
<div class="error">Hello, you're using Internet Explorer.  Some of the images you need to use this app will not show up on your device.  Please use Internet Explorer 8 or use another browser like Safari, <a href="http://www.google.com/chrome">Chrome</a> or <a href="http://www.getfirefox.com">Firefox</a></div>
<![endif]-->	
<div class="help">
	<div class="shorthand">
		<h2 class="toggles"><a href="#" onclick="show_hide('help');return false;">Help &#x25BC;</a></h2>
		<h2>
			<a href="#" onclick="shorthand(CCalc.html.get_el('shorthand').style.visibility);return false;">shorthand &#x25BC;</a>
		</h2>
		<h2>
			<a href="#" onclick="element_list(CCalc.html.get_el('element_list').style.visibility);return false;">elements &amp; isotopes  &#x25BC;</a>
		</h2>
	</div>
	<div id="element_list" style="visibility:hidden;display:none;"></div>
	<div id="shorthand" style="visibility:hidden;display:none;"></div>
	<!-- placeholder for the element information -->
	<div id="element_info" style="visibility:hidden;display:none;">
		<!-- data about the elements -->
		<div id="element_data"></div>
		<!-- isotope list here -->
		<h6><span class='large-screen'> Isotopes &amp; abundances</span>:</h6><b><br/></b>
		<div id="element_isotopes"></div>

		<div id="no_isotopes_entered" class="no_isotopes_entered">No isotopes known/entered for this element</div>
	</div>

	<div id="help">
		<b>How to use</b>:
		<ol><li>Place your cursor in the field at the top-left (it should be automatically there).</li>
		
		<li>Type a Chemical Formula</li>
		<li>Chemical composition and elemental analysis will be shown <i>as you type</i></li>
		</ol>
		 
		<b>optional</b>:<br>
		for each conversion, please alter the type of units as needed before converting
		<ul>
		<li>Converting mass to mmol
			<ul>
			<li>Enter a mass in the mass field, and click the arrow with the yellow box on it to get the mmol</li>
			</ul>
		</li>
		<li>Converting volume to mmol (no mass needed)
			<ul>
			<li>Enter a volume in the volume field, and a density, and click the arrow with the blue droplet on it to get the mmol</li>
			</ul>
		</li>
		<li>Converting mmol to volume/mass
			<ul>
			<li>Fill in the density field (if needed), and enter the value of mol/mmol.  conversion is automatic
			</li>
			</ul>
		</li>
		</ul>
	
	</div>
</div>

<div id="calculator">
	<h1>Chemical composition calculations<span id="share">share</span></h1>

	<div class="auto_overflow">
	<form action="" onsubmit="calculate_info(document.chemicals.formula.value);return false;" name="chemicals">
	<p>
		<input name="formula" id="formula" onkeyup="calculate_info(this.value);calculate_chn();" style="width: 300px;" type="text" placeholder="enter formula here">
		<label for="show_mass_spec"><input id="show_mass_spec" name="show_mass_spec" onclick="var d = document.chemicals.formula.value;calculate_info(d);" type="checkbox"> predict [M<sup>+</sup>] peak </label><input id="reset_form" value="reset" type="reset">
	</p>
	<div class="auto_overflow">
		<div id="error"></div>
		<div class="clearfix"></div>
	</div>
	<div id="working">calculation in progress ... </div>
	<div class="auto_overflow">
		<h3>COSSH forms</h3>
		<div class="conversion_section auto_overflow">
			<div class="cossh_form">
				<div class="mass">
					<div class="u_h mass">Mass used</div>
					<div class="mass"><input id="mass" name="amt_added" onkeyup="update_mmols(molecular_mass)" class="mass" type="text" placeholder="e.g. 1.2"><!-- onkeyup="calculate_info(document.chemicals.formula.value)" --></div>
				</div>
				<div class="unit">
					<div class="u_h unit">unit</div>
					<div class="unit"><select name="mass_multiplier" id="mass_multiplier"><option selected="selected" value="1">g</option><option value="0.001">mg</option><option value="1000">kg</option></select></div>
				</div>
				<!-- volume and units -->
				<div class="volume">
					<div class="u_h volume">volume</div>
					<div class="volume"><input name="volume" id="volume" value="1" type="text"  placeholder="e.g. 2.3"></div>
				</div>
				<div class="unit">
					<div class="u_h unit">unit</div>
					<div class="unit"><select name="volume_multiplier" id="volume_multiplier" onchange="update_volume(molecular_mass)"><option value="1000">L</option><option value="1" selected="selected">ml</option><option value="0.001">L</option></select></div>
				</div>

				<div class="density">
					<div class="u_h density">density</div>
					<div class="density"><input name="density" id="density" value="1" style="width:20px;" type="text" placeholder="e.g. 0.987"></div>
				</div>
			</div>
			<!-- end the cossh form row -->

			<div class="cossh_form">
				<div class="update">
					<div class="u_h update">update</div>
					<div class="update">
						<map id="arrows" name="arrows">
						<area shape="rect" coords="0,0,27,25" href="#" onclick="update_mass(molecular_mass)" alt="update the mass based on the mmol">
						<area shape="rect" coords="28,0,55,12" href="#" onclick="update_mmols(molecular_mass)" alt="update the mmol based on the mass">
						<area shape="rect" coords="28,13,55,25" href="#" onclick="update_mmols_volume(molecular_mass)" alt="update the mmol based on the volume">
						</map>
						<img src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAADcAAAAZCAYAAACVfbYAAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH2AMNCyk07tQSUAAAAB10RVh0Q29tbWVudABDcmVhdGVkIHdpdGggVGhlIEdJTVDvZCVuAAABRElEQVRYw92XIRKDMBBFSSa6qqZTWcEBuAOnwFZ1MJgKNKIGw1TVcoregQMgKjs1VRyAVKWTCbsN0JKkWZsJ5GV3/98EgcdBXD1Ymqb803pVVe+z0zzkfdEOWJirUPvTY7B2OW7QfRAgczVTEIgAxiBVQONwNA/hcuvgbAkYdQ37jgxIfRQSAe4lnABE4da7O/9nuL5oCfsnMCEk59VVCwb6nAz2vG2N+aDO11Rvw8RFVktiOmNLXJiAU32O+tRj4PhlEsxkqRPTmRsLJ/cg1mu62ZLauNGxYHVUfjX5MPVWbamlGnVUBkmTTRYWVC3VEl1S2bA4dHEgZy1pMq2vYeJCbTc9ljUI+GezpQ1ACEKAzgF0bnCGRGSKsMil6eWrQPQcs/Vj2ANiPmcvNltSHzPmLBzkbWP8Dp0tXQrs6aMbwaB4AbAJruvzJ6U9AAAAAElFTkSuQmCC" usemap="#arrows" border=0 alt="click to change">
					</div>
				</div>
				<div class="equivalents">
					<div class="u_h equivalents"><abbr title="works only when updating the mass/volume">equiv</abbr></div>
					<div class="equivalents"><input name="equivalents" id="equivalents" class="equivalents" value="1" type="text" placeholder=" 1 "></div>
				</div>
				<div class="mmols">
					<div class="u_h mmols">mmols</div>
					<div class="mmols"><input name="mmols" id="mmols" class="mmols" onkeyup="update_mass(molecular_mass)" type="text" placeholder="e.g. 1.02"></div>
				</div>

				<div class="unit">
					<div class="u_h unit">unit</div>
					<div class="unit"><select id="mmol_multiplier" name="mmol_multiplier"><option selected="selected" value="0.001">mmol</option><option value="1">mol</option></select></div>
				</div>
				<div class="clearfix"></div>
			</div>
			<!-- end the cossh form row -->
		</div>
		<div class="clearfix"></div>
	</div>

	<div id="elemental_analysis">
		<h3>Elemental analysis workup</h3>
		<div class="cossh_form">
			<div class="multiplier"><input name="multiplier" id="multiplier" onkeyup="calculate_chn();" placeholder="mult"></div>
			<div class="e_c"><input name="c" id="c" onkeyup="calculate_chn();" placeholder="%C"></div>
			<div class="e_h"><input name="h" id="h" onkeyup="calculate_chn();" placeholder="%H"></div>
			<div class="e_n"><input name="n" id="n" onkeyup="calculate_chn();" placeholder="%N"></div>
		</div>
		<div class="cossh_form">
			<div id="yields">&#8594; </div>

			<div class="e_c">C: <span id="e_c"></span></div>
			<div class="e_h">H: <span id="e_h"></span></div>
			<div class="e_n">N: <span id="e_n"></span></div>
		</div>
		<div id="chn_copy_paste" style="visibility:hidden;display:none;">expected for <span id="molecular_formula"></span>&nbsp;(found):
		C: <span id="c_expected"></span>&nbsp;(<span id="c_found">0</span>)
		H: <span id="h_expected"></span>&nbsp;(<span id="h_found">0</span>)
		N: <span id="n_expected"></span>&nbsp;(<span id="n_found">0</span>)
		</div>
	</div>
	</form>
	<div class="clearfix"></div>

</div>
<div class="auto_overflow">
 <div id="composition">
	<h3 id="composition_title">Composition</h3>
		<div class="loading" style="display:none"></div>
		<div id="condensed">
			<table class="full_width">
				<thead>
					<tr>
						<td>Condensed formula</td>
						<td>Composed of</td>
						<td>Mass</td>
						<td>Monoisotopic mass</td>
						<td><abbr title="MSDS from Sigma Aldrich">MSDS</abbr></td>
					</tr>
				</thead>
				<tbody>
					<tr>
						<td class="formula" id="condensed_formula"></td>
						<td class="formula" id="condensed_composition"></td>
						<td class="formula" id="condensed_mass"></td>
						<td class="formula" id="condensed_mono"></td>
						<td id="condensed_msds"></td>
					</tr>
				</tbody>
			</table>
		</div>
		<div id="composition_elements" class="outline">
		<div>
			<div class="header">
				<div class="element">Element</div>
				<div class="element">Number of Atoms</div>
				<div class="atomic_mass">Atomic mass</div>
				<div class="net_mass align_r">Total Mass (amu)</div>
				<div class="align_r percent_composition">% composition</div>
				<div class=clearfix></div>
			</div>
		</div>
			<div id="info" class="info">&nbsp;</div>
		</div>
		<div id="mass_spec">
		<h3>[M<sup>+</sup>] prediction</h3>
		<div class=outline>
			<div class=header><div class="ms_header">Predicted Mass Spectrum for the molecular ion [M<sup>+</sup>].</div></div>
			<div id="mass_spec_graph"></div>
		</div>
		</div>	

		<div class="clearfix"></div>
	</div>
</div>
</div>


<div id="footer">
	<div id="bottom_left" class="bottom"><a href="http://sgazard.github.io/elemental/" title="current version is here">Version 1.3.5 (13-Jan-2015)</a></div>
	<div id="bottom_right" class="bottom">
	 If you like this tool or want to send on comments, please contact <a href="https://github.com/sgazard/elemental/">me on GitHub</a>
	</div>
</div>
</body>
</html>